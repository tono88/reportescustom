<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="report_fel_invoice">
    <t t-foreach="docs" t-as="o">

      <!-- Definir company ANTES del t-call para que el external_layout no falle -->
      <t t-set="company" t-value="o.company_id or env.company"/>

      <!-- Usar el layout limpio del módulo (sin footer con correo) -->
      <t t-call="l10n_gt_fel_megaprint_report.external_layout_clean_footer">
        <div class="page">
          <t t-set="o" t-value="o.with_context(lang=lang)"/>

          <style type="text/css">
            .fel * { font-family: "DejaVu Sans","sans-serif"; color:#111; font-size:10pt; }
            .fel .title-small { text-transform:uppercase; font-weight:700; font-size:9pt; letter-spacing:.3px; color:#555; }
            .fel .title-big   { text-transform:uppercase; font-weight:800; font-size:14pt; letter-spacing:.8px; }
            .fel .table { width:100%; border-collapse:collapse; }
            .fel .table.outer { border:1px solid #222; }
            .fel .table th { background:#f2f2f2; text-transform:uppercase; font-weight:700; padding:6px 8px; border:1px solid #222; }
            .fel .table td { padding:6px 8px; border:1px solid #222; vertical-align:top; }
            .fel .text-right { text-align:right; }
            .fel .text-center { text-align:center; }
            .fel .fw-bold { font-weight:700; }
            .fel .mt-6 { margin-top:6px; }
            .fel .mt-10 { margin-top:10px; }
            .fel .note { font-size:8pt; color:#444; }
            .fel .final { margin-top:12mm; }
          </style>

          <main class="fel">
            <!-- Títulos -->
            <div class="text-right" style="margin-top:2mm; margin-bottom:3mm;">
			  <div class="title-small">DOCUMENTO TRIBUTARIO ELECTRÓNICO</div>
			  <div class="title-big">
				<t t-if="o.move_type == 'out_invoice'">FACTURA</t>
				<t t-elif="o.move_type == 'out_refund'">NOTA DE CRÉDITO</t>
				<t t-elif="o.move_type == 'in_invoice'">FACTURA PROVEEDOR</t>
				<t t-elif="o.move_type == 'in_refund'">NOTA DE CRÉDITO PROVEEDOR</t>
			  </div>
			</div>
			<!-- Datos del documento origen: SOLO para Nota de Crédito -->
				<t t-if="o.move_type == 'out_refund'">
				  <table class="table outer mt-6">
					<tr>
					  <td class="fw-bold" style="width:35%;">No. AUTORIZACIÓN DOCUMENTO ORIGEN:</td>
					  <td><span t-esc="(o.factura_original_id and o.factura_original_id.firma_fel) or ''"/></td>
					</tr>
					<tr>
					  <td class="fw-bold">FECHA EMISIÓN DOC. ORIGEN:</td>
					  <td>
						<t t-if="o.factura_original_id and o.factura_original_id.invoice_date">
						  <t t-out="o.factura_original_id.invoice_date.strftime('%d-%m-%Y %H:%M:%S')"/>
						</t>
					  </td>
					</tr>
					<!-- AQUI va el bloque de MOTIVO corregido -->
					<!-- ... -->
					<tr>
  <td class="fw-bold">MOTIVO:</td>
  <td>
    Error en documento

  </td>
</tr>


					<tr>
					  <td class="fw-bold">SERIE DOCUMENTO ORIGEN:</td>
					  <td><span t-esc="(o.factura_original_id and o.factura_original_id.serie_fel) or ''"/></td>
					</tr>
					<tr>
					  <td class="fw-bold">NUMERO DOCUMENTO ORIGEN:</td>
					  <td><span t-esc="(o.factura_original_id and o.factura_original_id.numero_fel) or ''"/></td>
					</tr>
				  </table>
				</t>

            <!-- Emisor / FEL -->
            <table class="table outer">
              <tr>
                <td colspan="2" style="width:55%;">
                  <div class="fw-bold" style="font-size:11pt; text-transform:uppercase;">
                    <span t-esc="o.company_id.name or ''"/>
                  </div>
                  <div>NIT: <span t-esc="o.company_id.vat or ''"/></div>
                  <div t-esc="(o.company_id.partner_id and o.company_id.partner_id.contact_address) or (o.company_id.contact_address) or ''"/>
                </td>
                <td style="width:22.5%;">
                  <div class="fw-bold">FECHA DE EMISIÓN:</div>
                  <div t-field="o.invoice_date"/>
                </td>
                <td style="width:22.5%;">
                  <div class="fw-bold">NÚMERO DTE:</div>
                  <div t-esc="o.numero_fel or ''"/>
                </td>
              </tr>
              <tr>
                <td style="width:27.5%;">
                  <div class="fw-bold">SERIE</div>
                  <div t-esc="o.serie_fel or ''"/>
                </td>
                <td style="width:27.5%;">
                  <div class="fw-bold">No. AUTORIZACIÓN</div>
                  <div t-esc="o.firma_fel or ''"/>
                </td>
                <td>
                  <div class="fw-bold">CERTIFICADOR:</div>
                  <div>MEGAPRINT, S.A. NIT: 50510231</div>
                </td>
                <td>
                  <div class="fw-bold">FECHA CERTIFICACIÓN:</div>
                  <div t-if="o.create_date" t-out="o.create_date.strftime('%Y-%m-%d')"/>
                  <div t-if="not o.create_date and o.invoice_date" t-out="o.invoice_date.strftime('%Y-%m-%d')"/>
                </td>
              </tr>
            </table>

            <!-- Receptor -->
            <table class="table outer mt-6">
              <tr>
                <td style="width:15%;" class="fw-bold">NOMBRE:</td>
                <td style="width:55%;" t-esc="o.partner_id.name or ''"/>
                <td style="width:10%;" class="fw-bold">NIT:</td>
                <td style="width:20%;">
				  <span t-esc="o.partner_id.vat or 'CF'"/>
				</td>
              </tr>
              <tr>
                <td class="fw-bold">DIRECCIÓN:</td>
                <td colspan="3" t-esc="o.partner_id.contact_address or ''"/>
              </tr>
            </table>

            <!-- Detalle (sin columnas Descuento e Impuesto) -->
            <t t-set="product_lines" t-value="[l for l in o.invoice_line_ids if l.display_type == 'product']"/>
            <table class="table outer mt-10">
              <thead>
                <tr>
                  <th style="width:8%;">Tipo</th>
                  <th style="width:12%;" class="text-right">Cantidad</th>
                  <th>Descripción</th>
                  <th style="width:16%;" class="text-right">Precio Unitario</th>
				  <th style="width:12%;" class="text-right">Impuesto</th>
                  <th style="width:16%;" class="text-right">Total</th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="product_lines" t-as="l">
                  <tr>
                    <td class="text-center">
                      <t t-set="ptype" t-value="(l.product_id.type or 'product')"/>
                      <t t-out="'B' if ptype in ('product','consu') else 'S'"/>
                    </td>
                    <td class="text-right">
                      <span t-field="l.quantity"/>
                      <span t-if="l.product_uom_id" t-esc="l.product_uom_id.name"/>
                    </td>
                    <td t-esc="l.name"/>
                    <!-- Precio unitario CON IVA = price_total / quantity -->
                    <td class="text-right">
                      <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                      <t t-out="'%.2f %s' % (((l.price_total or 0.0) / (l.quantity or 1.0)), sym)"/>
                    </td>
					<!-- IMPUESTO (diferencia entre total con IVA y subtotal sin IVA) -->
<td class="text-right">
  <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
  <t t-out="'%.2f %s' % (((l.price_total or 0.0) - (l.price_subtotal or 0.0)), sym)"/>
</td>
                    <!-- Total CON IVA -->
                    <td class="text-right">
                      <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                      <t t-out="'%.2f %s' % (l.price_total or 0.0, sym)"/>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>

            <!-- Totales: solo Total -->
            <div style="display:flex; justify-content:flex-end; margin-top:8px;">
              <div style="flex:0 0 40%;">
                <table class="table outer">
                  <tbody>
                    <tr>
                      <td class="fw-bold">Total</td>
                      <td class="text-right fw-bold">
                        <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                        <t t-out="'%.2f %s' % (o.amount_total or 0.0, sym)"/>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Final del documento: Total en letras + ISR -->
            <div class="final">
              <table class="table outer">
                <tr>
                  <td style="width:25%;" class="fw-bold">TOTAL EN LETRAS:</td>
                  <td class="text-upper">
                    <span t-out="o.amount_total_gt_words or ''"/>
                  </td>
                </tr>
              </table>
              <div class="note" style="margin-top:6px;">Sujeto a pagos trimestrales ISR</div>
              <div class="note" style="margin-top:6px;">Agente de Retención del IVA</div>
            </div>

          </main>
        </div>
      </t>
    </t>
  </template>
</odoo>
