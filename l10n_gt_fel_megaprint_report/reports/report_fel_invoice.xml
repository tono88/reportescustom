<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="report_fel_invoice">
    <!-- Iteramos docs y aseguramos layout con meta UTF-8 -->
    <t t-foreach="docs" t-as="o">
      <t t-call="web.external_layout">
        <div class="page">
          <t t-set="o" t-value="o.with_context(lang=lang)"/>

          <style type="text/css">
            /* Oculta header/footer estándar para evitar logo/títulos duplicados */
            .header, header, .footer, footer { display:none !important; }

            .fel * { font-family: "DejaVu Sans","sans-serif"; color:#111; font-size:10pt; }
            .fel .hstack { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
            .fel .title-small { text-transform:uppercase; font-weight:700; font-size:9pt; letter-spacing:.3px; color:#555; }
            .fel .title-big { text-transform:uppercase; font-weight:800; font-size:14pt; letter-spacing:.8px; }
            .fel .table { width:100%; border-collapse:collapse; }
            .fel .table.outer { border:1px solid #222; }
            .fel .table th { background:#f2f2f2; text-transform:uppercase; font-weight:700; padding:6px 8px; border:1px solid #222; }
            .fel .table td { padding:6px 8px; border:1px solid #222; vertical-align:top; }
            .fel .text-right { text-align:right; }
            .fel .text-center { text-align:center; }
            .fel .fw-bold { font-weight:700; }
            .fel .mt-6 { margin-top:6px; }
            .fel .mt-10 { margin-top:10px; }
            .fel .note { font-size:8pt; color:#444; }
            /* Evita doble borde inter-celda */
            .fel .outer td + td, .fel .outer th + th { border-left:1px solid #222; }
          </style>

          <main class="fel">
            <!-- Encabezado propio (logo izq, títulos der) -->
            <div class="hstack" style="margin-top:2mm; margin-bottom:3mm;">
              <div style="flex:1;">
                <t t-if="o.company_id.logo">
                  <img t-att-src="image_data_uri(o.company_id.logo)"
                       style="max-height:80px; max-width:220px;"/>
                </t>
              </div>
              <div style="text-align:right;">
                <div class="title-small">DOCUMENTO TRIBUTARIO ELECTR&#211;NICO</div>
                <div class="title-big">FACTURA</div>
              </div>
            </div>

            <!-- Emisor / FEL -->
            <table class="table outer">
              <tr>
                <td colspan="2" style="width:55%;">
                  <div class="fw-bold" style="font-size:11pt; text-transform:uppercase;">
                    <span t-esc="o.company_id.name or ''"/>
                  </div>
                  <div>NIT: <span t-esc="o.company_id.vat or ''"/></div>
                  <div t-esc="(o.company_id.partner_id and o.company_id.partner_id.contact_address) or (o.company_id.contact_address) or ''"/>
                </td>
                <td style="width:22.5%;">
                  <div class="fw-bold">FECHA DE EMISI&#211;N:</div>
                  <div t-field="o.invoice_date"/>
                </td>
                <td style="width:22.5%;">
                  <div class="fw-bold">N&#218;MERO DTE:</div>
                  <div t-esc="o.numero_fel or ''"/>
                </td>
              </tr>
              <tr>
                <td style="width:27.5%;">
                  <div class="fw-bold">SERIE</div>
                  <div t-esc="o.serie_fel or ''"/>
                </td>
                <td style="width:27.5%;">
                  <div class="fw-bold">No. AUTORIZACI&#211;N</div>
                  <div t-esc="o.firma_fel or ''"/>
                </td>
                <td>
                  <div class="fw-bold">CERTIFICADOR:</div>
                  <div>MEGAPRINT, S.A. NIT: 50510231</div>
                </td>
                <td>
                  <div class="fw-bold">FECHA CERTIFICACI&#211;N:</div>
                  <div t-if="o.create_date" t-out="o.create_date.strftime('%Y-%m-%d')"/>
                  <div t-if="not o.create_date and o.invoice_date" t-out="o.invoice_date.strftime('%Y-%m-%d')"/>
                </td>
              </tr>
            </table>

            <!-- Receptor -->
            <table class="table outer mt-6">
              <tr>
                <td style="width:15%;" class="fw-bold">NOMBRE:</td>
                <td style="width:55%;" t-esc="o.partner_id.name or ''"/>
                <td style="width:10%;" class="fw-bold">NIT:</td>
                <td style="width:20%;" t-esc="o.partner_id.vat or 'CF'"/>
              </tr>
              <tr>
                <td class="fw-bold">DIRECCI&#211;N:</td>
                <td colspan="3" t-esc="o.partner_id.contact_address or ''"/>
              </tr>
            </table>

            <!-- Detalle -->
            <t t-set="product_lines" t-value="[l for l in o.invoice_line_ids if l.display_type == 'product']"/>
            <table class="table outer mt-10">
              <thead>
                <tr>
                  <th style="width:7%;">Tipo</th>
                  <th style="width:12%;" class="text-right">Cantidad</th>
                  <th>Descripci&#211;n</th>
                  <th style="width:13%;" class="text-right">Precio Unitario</th>
                  <th style="width:13%;" class="text-right">Descuento</th>
                  <th style="width:13%;" class="text-right">Impuesto</th>
                  <th style="width:13%;" class="text-right">Total</th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="product_lines" t-as="l">
                  <tr>
                    <td class="text-center">
                      <t t-set="ptype" t-value="(l.product_id.type or 'product')"/>
                      <t t-out="'B' if ptype in ('product','consu') else 'S'"/>
                    </td>
                    <td class="text-right">
                      <span t-field="l.quantity"/>
                      <span t-if="l.product_uom_id" t-esc="l.product_uom_id.name.replace('³','&#179;')"/>
                    </td>
                    <td t-esc="l.name"/>
                    <td class="text-right">
                      <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                      <t t-out="'%.2f %s' % (l.price_unit or 0.0, sym)"/>
                    </td>
                    <td class="text-right">
                      <t t-out="('%.2f' % (l.discount or 0.0))"/>%
                    </td>
                    <td class="text-right">
                      <t t-set="line_tax" t-value="(l.price_total or 0.0) - (l.price_subtotal or 0.0)"/>
                      <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                      <t t-out="'%.2f %s' % (line_tax, sym)"/>
                    </td>
                    <td class="text-right">
                      <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                      <t t-out="'%.2f %s' % (l.price_subtotal or 0.0, sym)"/>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>

            <!-- Totales / Total en letras -->
            <div style="display:flex; gap:10px; margin-top:8px;">
              <!-- Izquierda: Total en letras (sin número) -->
              <div style="flex:1;">
                <table class="table outer">
                  <tr>
                    <td style="width:38%;" class="fw-bold">TOTAL EN LETRAS:</td>
                    <td class="text-upper">
                      <span t-out="o.amount_total_gt_words or ''"/>
                    </td>
                  </tr>
                </table>
                <div class="note" style="margin-top:6px;">SUJETO A RETENCI&#211;N DEFINITIVA ISR</div>
              </div>

              <!-- Derecha: Totales -->
              <div style="flex:0 0 40%;">
                <table class="table outer">
                  <tbody>
                    <tr>
                      <td>Subtotal</td>
                      <td class="text-right">
                        <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                        <t t-out="'%.2f %s' % (o.amount_untaxed or 0.0, sym)"/>
                      </td>
                    </tr>
                    <tr>
                      <td>IVA 12%</td>
                      <td class="text-right">
                        <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                        <t t-out="'%.2f %s' % (o.amount_tax or 0.0, sym)"/>
                      </td>
                    </tr>
                    <tr>
                      <td class="fw-bold">Total</td>
                      <td class="text-right fw-bold">
                        <t t-set="sym" t-value="o.currency_id and o.currency_id.symbol or ''"/>
                        <t t-out="'%.2f %s' % (o.amount_total or 0.0, sym)"/>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </main>
        </div>
      </t>
    </t>
  </template>
</odoo>
