<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="report_fel_invoice">
    <!-- Contenedor que garantiza <main> para el motor PDF -->
    <t t-call="web.html_container">
      <!-- Recorremos los documentos y definimos 'o' -->
      <t t-foreach="docs" t-as="o">
        <div class="page">

          <!-- ====== Estilos locales ====== -->
          <style type="text/css">
            .fel * { font-family: "DejaVu Sans","sans-serif"; color:#111; font-size:10pt; }
            .fel .hstack { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
            .fel .title-small { text-transform:uppercase; font-weight:700; font-size:9pt; letter-spacing:.3px; color:#555; }
            .fel .title-big { text-transform:uppercase; font-weight:800; font-size:14pt; letter-spacing:.8px; }
            .fel .table { width:100%; border-collapse:collapse; }
            .fel .table.outer { border:1px solid #222; }
            .fel .table th { background:#f2f2f2; text-transform:uppercase; font-weight:700; padding:6px 8px; border:1px solid #222; }
            .fel .table td { padding:6px 8px; border:1px solid #222; vertical-align:top; }
            .fel .no-border td, .fel .no-border th { border:none!important; }
            .fel .text-right { text-align:right; }
            .fel .text-center { text-align:center; }
            .fel .fw-bold { font-weight:700; }
            .fel .mt-6 { margin-top:6px; }
            .fel .mt-10 { margin-top:10px; }
            .fel .note { font-size:8pt; color:#444; }
            /* Evita doble borde donde no corresponde */
            .fel .outer td + td, .fel .outer th + th { border-left:1px solid #222; }
          </style>

          <div class="fel">

            <!-- ====== Encabezado propio (sin external_layout) ====== -->
            <div class="hstack" style="margin-top:2mm; margin-bottom:3mm;">
              <div style="flex:1;">
                <t t-if="o.company_id.logo">
                  <img t-att-src="image_data_uri(o.company_id.logo)"
                       style="max-height:80px; max-width:220px;"/>
                </t>
              </div>
              <div style="text-align:right;">
                <div class="title-small">Documento Tributario Electrónico</div>
                <div class="title-big">Factura</div>
              </div>
            </div>

            <!-- ====== Emisor / FEL ====== -->
            <table class="table outer">
              <tr>
                <td colspan="2" style="width:55%;">
                  <div class="fw-bold" style="font-size:11pt; text-transform:uppercase;">
                    <span t-out="o.company_id.name or ''"/>
                  </div>
                  <div>NIT: <span t-out="o.company_id.vat or ''"/></div>
                  <div t-out="(o.company_id.partner_id and o.company_id.partner_id.contact_address) or (o.company_id.contact_address) or ''"/>
                </td>
                <td style="width:22.5%;">
                  <div class="fw-bold">FECHA DE EMISIÓN:</div>
                  <div t-field="o.invoice_date"/>
                </td>
                <td style="width:22.5%;">
                  <div class="fw-bold">NÚMERO DTE:</div>
                  <div t-out="o.numero_fel or ''"/>
                </td>
              </tr>
              <tr>
                <td style="width:27.5%;">
                  <div class="fw-bold">SERIE</div>
                  <div t-out="o.serie_fel or ''"/>
                </td>
                <td style="width:27.5%;">
                  <div class="fw-bold">No. AUTORIZACIÓN</div>
                  <div t-out="o.firma_fel or ''"/>
                </td>
                <td>
                  <div class="fw-bold">CERTIFICADOR:</div>
                  <div>MEGAPRINT, S.A. NIT: 50510231</div>
                </td>
                <td>
                  <div class="fw-bold">FECHA CERTIFICACIÓN:</div>
                  <div t-if="o.create_date" t-out="o.create_date.strftime('%Y-%m-%d')"/>
                  <div t-if="not o.create_date and o.invoice_date" t-out="o.invoice_date.strftime('%Y-%m-%d')"/>
                </td>
              </tr>
            </table>

            <!-- ====== Receptor ====== -->
            <table class="table outer mt-6">
              <tr>
                <td style="width:15%;" class="fw-bold">NOMBRE:</td>
                <td style="width:55%;" t-out="o.partner_id.name or ''"/>
                <td style="width:10%;" class="fw-bold">NIT:</td>
                <td style="width:20%;" t-out="o.partner_id.vat or 'CF'"/>
              </tr>
              <tr>
                <td class="fw-bold">DIRECCIÓN:</td>
                <td colspan="3" t-out="o.partner_id.contact_address or ''"/>
              </tr>
            </table>

            <!-- ====== Detalle ====== -->
            <t t-set="product_lines" t-value="[l for l in o.invoice_line_ids if l.display_type == 'product']"/>
            <table class="table outer mt-10">
              <thead>
                <tr>
                  <th style="width:7%;">Tipo</th>
                  <th style="width:12%;" class="text-right">Cantidad</th>
                  <th>Descripción</th>
                  <th style="width:13%;" class="text-right">Precio Unitario</th>
                  <th style="width:13%;" class="text-right">Descuento</th>
                  <th style="width:13%;" class="text-right">Impuesto</th>
                  <th style="width:13%;" class="text-right">Total</th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="product_lines" t-as="l">
                  <tr>
                    <td class="text-center">
                      <t t-set="ptype" t-value="(l.product_id.type or 'product')"/>
                      <t t-out="'B' if ptype in ('product','consu') else 'S'"/>
                    </td>
                    <td class="text-right">
                      <span t-field="l.quantity"/>
                      <span t-if="l.product_uom_id" t-field="l.product_uom_id" groups="uom.group_uom"/>
                    </td>
                    <td t-esc="l.name"/>
                    <td class="text-right">
                      <span t-field="l.price_unit" t-options="{'widget':'monetary','display_currency':o.currency_id}"/>
                    </td>
                    <td class="text-right">
                      <t t-out="('%.2f' % (l.discount or 0.0))"/>%
                    </td>
                    <td class="text-right">
                      <!-- Monto de impuesto por línea -->
                      <t t-set="line_tax" t-value="(l.price_total or 0.0) - (l.price_subtotal or 0.0)"/>
                      <span t-out="line_tax" t-options="{'widget':'monetary','display_currency':o.currency_id}"/>
                    </td>
                    <td class="text-right">
                      <span t-field="l.price_subtotal" t-options="{'widget':'monetary','display_currency':o.currency_id}"/>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>

            <!-- ====== Totales / Total en letras ====== -->
            <div style="display:flex; gap:10px; margin-top:8px;">
              <!-- Izquierda: Total en letras (SIN número a la derecha) -->
              <div style="flex:1;">
                <table class="table outer">
                  <tr>
                    <td style="width:38%;" class="fw-bold">TOTAL EN LETRAS:</td>
                    <td class="text-upper">
                      <span t-out="o.amount_total_gt_words or ''"/>
                    </td>
                  </tr>
                </table>
                <div class="note" style="margin-top:6px;">SUJETO A RETENCIÓN DEFINITIVA ISR</div>
              </div>

              <!-- Derecha: caja de totales -->
              <div style="flex:0 0 40%;">
                <table class="table outer">
                  <tbody>
                    <tr>
                      <td>Subtotal</td>
                      <td class="text-right">
                        <span t-field="o.amount_untaxed"
                              t-options="{'widget':'monetary','display_currency':o.currency_id}"/>
                      </td>
                    </tr>
                    <tr>
                      <td>IVA 12%</td>
                      <td class="text-right">
                        <span t-field="o.amount_tax"
                              t-options="{'widget':'monetary','display_currency':o.currency_id}"/>
                      </td>
                    </tr>
                    <tr>
                      <td class="fw-bold">Total</td>
                      <td class="text-right fw-bold">
                        <span t-field="o.amount_total"
                              t-options="{'widget':'monetary','display_currency':o.currency_id}"/>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div> <!-- /.fel -->
        </div>   <!-- /.page -->
      </t>
    </t>
  </template>
</odoo>
